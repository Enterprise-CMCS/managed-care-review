# app-api

This service builds our backend api in NodeJS and using GraphQL as the api protocol and contains all important backend tests.

## Significant dependencies

Familiarizing yourself with these dependencies will help you navigate the codebase.

-   [Apollo Server](https://www.apollographql.com/docs/apollo-server/)
-   [AWS Cognito](https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html)
-   [GraphQL](https://graphql.org/learn/)

## Useful scripts

In the project directory, you can run:

### `pnpm clean`

Clear pnpm cache and reinstall.\

### `pnpm test`

Launches the test runner in the interactive watch mode.\

## Organization and important files

### `/authn`

Sets up authentication based on environment variables. Options are local or Amazon Cognito authentication. IDM (CMS identity management tool) works through Cognito auth.

### `/handlers`

-   Sets up api endpoints and maps to functions in the `serverless.yml`. Our main endpoint is `/graphql`.
-   **`apollo_gql.ts`** main api entrypoint - configures all dependencies based on environment variables and type of auth.

### `/postgres`

-   Sets up the database connection based on environment variables.

### `/resolvers`

-   GraphQL resolvers and tests for all queries and mutations. See `configureResolver.ts` for a comprehensive list.
-   `userResolver.ts` needed to ensure the user (which comes from the auth provider, not graphql) is valid.

### `/parameterStore`

-   `awsParameterStore.ts` main file that contains general [AWS SSM](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html) parameter store functions.
    -   `ParameterStore.getParameter()` is used to retrieve parameter store values. This uses [getParameter](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html#getParameter-property) operation in AWS SSM
-   `/emailParameterStore/emailParameterStore.ts` this file contains two functions used to configure our automated emails for local and cloud deployment.

    -   `newAWSEmailParameterStore` is for emailer configuration of `Dev`, `Impl` and `Prod` environments done in `/handlers/apollo_gql.ts`. The exception is `getStateAnalystsEmails` where it is called at resolvers before passed to emailer functions.
    -   `newLocalEmailParameterStore` is for emailer configuration of `LOCAL` environment done in `/handlers/apollo_gql.ts`.

-   Email parameter stores can be accessed through AWS console in `AWS > System Manager > Parameter Store`. Environments `Managed Care Dev`, `Managed Care Impl` and `Managed Care Dev Prod` each have a set of email parameter stores.
-   Discussion of expected parameter store values can be found in [Configuration](../../docs/Configuration.md).

### `/gen`

-   This folder is auto-generated by the [`app-graphql`](../app-graphql) and / [`app-proto`](../app-proto) services

## Adding new a new email parameter stores

-   This requires you to have AWS Console access, which is managed via Active Directory and Cloudtamer.
-   After accessing AWS Console navigate to `System Manager > Parameter Store`.
-   Locate the `Create parameter` button and press to begin adding a new store.
-   Create a new parameter store **Name** following existing patterns for store names.
    -   For configuration emails `/configuration/email/[name]`
    -   For new state analyst emails `/configuration/[state abbreviation]/stateanalysts/email`
-   Choose a `Type` for the store, currently all email parameter stores are either `String` or `StringList`
-   Input values for the parameter store.
    -   **It's highly recommended to input values in `Managed Care Dev` and `Managed Care Impl` that imitate the `Type` of the parameter store. e.g. parameter store `Type` of `StringList` should have the value `string1@example.com,string1@example.com,string1@example.com`**
-   Press `Create parameter` to create the new store
-   You will need to repeat this process for `Managed Care Dev`, `Managed Care Impl` and `Managed Care Prod` environments.
    -   <u>**The parameter store Name MUST be the same across environments.**</u>
-   Add a new function in `emalParameterStore.ts` to retrieve your value from aws parameter store.

## Tests

### Jest

-   Tests live alongside code. Api is tested mainly through integration tests, which require require running both the `app-api` and the `db` services.
